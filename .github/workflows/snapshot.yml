name: Snapshot Release
permissions:
  contents: write  # å¿…éœ€æƒé™

on:
  push:
    branches: [ "**" ]  # è‡ªåŠ¨è§¦å‘ï¼šæ‰€æœ‰åˆ†æ”¯æäº¤
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘å…¥å£ï¼ˆ[[11]](#__11)ï¼‰
    inputs:             # å¯é€‰ï¼šå®šä¹‰æ‰‹åŠ¨è§¦å‘æ—¶çš„è¾“å…¥å‚æ•°
      environment:
        description: 'æ‰‹åŠ¨å‘å¸ƒ'
        required: true
        default: 'stage'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´æäº¤åŽ†å²ï¼ˆ[[0]](#__0) [[10]](#__10)ï¼‰

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install

      - name: Extract package version
        id: package-version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get short commit SHA
        id: commit-id
        run: echo "short_sha=$(git rev-parse --short=7 HEAD)" >> $GITHUB_OUTPUT

      - name: Build Transmission version
        run: pnpm run build:transmission

      - name: Build qBittorrent version
        run: pnpm run build:qbittorrent

      - name: Compress files to ZIP
        run: |
          # åŽ‹ç¼© Transmission ç‰ˆæœ¬
          cd dist-transmission
          zip -r ../transmission-vue-${{ steps.package-version.outputs.version }}-transmission.zip .
          cd ..

          # åŽ‹ç¼© qBittorrent ç‰ˆæœ¬ (åœ¨ public å­ç›®å½•ä¸­)
          cd dist-qbittorrent
          zip -r ../transmission-vue-${{ steps.package-version.outputs.version }}-qbittorrent.zip .
          cd ..

          # è¾“å‡ºæ–‡ä»¶è·¯å¾„ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "TRANSMISSION_ZIP=$(pwd)/transmission-vue-${{ steps.package-version.outputs.version }}-transmission.zip" >> $GITHUB_ENV
          echo "QBITTORRENT_ZIP=$(pwd)/transmission-vue-${{ steps.package-version.outputs.version }}-qbittorrent.zip" >> $GITHUB_ENV

      - name: Create Snapshot Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
          name: ${{ steps.package-version.outputs.version }}-${{ steps.commit-id.outputs.short_sha }}
          body: |
            Automated snapshot build from commit ${{ github.sha }}

            ## ðŸ“¦ Build Artifacts
            - `transmission-vue-${{ steps.package-version.outputs.version }}-transmission.zip` - Transmission å®¢æˆ·ç«¯ç‰ˆæœ¬
            - `transmission-vue-${{ steps.package-version.outputs.version }}-qbittorrent.zip` - qBittorrent å®¢æˆ·ç«¯ç‰ˆæœ¬
          prerelease: true
          files: |
            ${{ env.TRANSMISSION_ZIP }}
            ${{ env.QBITTORRENT_ZIP }}

        env:
          GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
